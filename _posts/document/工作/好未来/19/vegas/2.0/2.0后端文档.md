[TOC]

# 工具模板创建
需要在创建工具模板的时候需要定义一下几种模板:
- 元数据模板(非特定情况不用声明)
- 原始据模板
- 结果模板
- 统计模板

## 概念解释

### 原始数据模板
数据模板是用来承载标注过程中需要使用到的资源,如音频的url,文字的分段,图片的url.

每个标注工具应该有自己的数据模板,前段可以根据数据模板去开发所需要的标注工具.

原始数据模板用来指定后端所使用的状态流.

- 有后台提供统一的json字段,后台对原始数据不做任何处理,只进行拆分和存储

#### 后端处理
1. 后端在创建任务的时候会根据,元数据模板中所定义的字段属性去check

2. 后端根据元数据模板校验数据流配置是否正确.

3. 在标注质检流程中后端只对标有(final)属性的元数据进行处理


**创建工具模板的时候,定义数据模板字段**

**创建任务的时候,会检查提交的json是否符合对应的数据模板**

### 结果模板
结果模板是用来承载标注结果的.

结果模板非常重要,数据导出和数据统计会根据结果模板生成相应的数据.

前段在完成标注时会将标注结果填充到结果模板里,后端进行保存.

- 结果模板定义好之后,后端会根据定义的模板对前端提交的数据进行check
- 统计和导出户依赖结果模板,也就是说结果模板定义前端以及用户所能使用的字段.这些字段对后端来说都是不可见的
- 后对对数据只进行拆分和存储,不做任何加工和处理


### 数据统计模板
数据统计模板是用来承载统计条件的es计算语句**统计模板可以有多个**.

统计模板只负责统计每个工具特定的统计需求如:
- 音频切割总时长;
- 音频切割段数;
- 音频切割文字数;
- 图片框数;
- 图片标签个数;
- 图片标签中文字个数;
- 文字段数;
- 文字个数;
- ......

前端在统计页面需要先获取相应的统计模板,然后调用后台接口后去统计结果进行渲染.

后端负责保存统计模板,和返回统计结果.

==统计模板需要和结果模板强相关,需要统计的字段必须保持一致==

- 统计模板为每个模板个性化定制的,只能统计结果数据
- 统计模板为ES的查询语法
- 统计模板可以有多个,每个统计模板的内容对应不同的图表

-------------

# 任务创建
任务创建指的是再[上传数据](http://221.122.129.16:8000/Vegas%20V2.0/index.html#g=1&p=%E4%B8%8A%E4%BC%A0%E6%95%B0%E6%8D%AE&id=j7li90)这一步

![上传数据](http://ww2.sinaimg.cn/large/006tNc79ly1g4p8fagbpoj30wg0dft99.jpg)


## 数据池及待标注元数据处理

数据池指的是,所有需要标注质检的原始数据,             原始数据再整个标注流程中是不变的,原始数据包含以下几种类型:

1. url:使用url承载数据,目前使用url承载数据的都是一个流(图片/音频/视频)
2. json文件:加载文件后将内容解析存储返回给前段

### 数据池
何为数据池,就是用来分发数据用的,一个数据在vegas中的生命周期,是从初始状态到终结状态[^01],每一个状态的操作都必须保证是**原子性的**,多少个状态对应多少个池,同时需要抽离状态转换器,保证次状态转换都是原子性操作.(需要做到单一职责和最低影响范围)


### 新版本如何处理待标注的原始数据

很简单,所有的原始数据全部存放在source字段下,所有的任务创建都是通过一个json文件格式如下(示例)
```
{
  "source": [
    {
      "fragment": [
        {
          "single": "provide_json"
        },
        {
          "single": "provide_url"
        }
      ]
    },
    {
      "fragment": [
        {
          "single": "provide_json"
        },
        {
          "single": "provide_url"
        }
      ]
    }
  ]
}
```
在这里重点声明,后端只对数据进行拆分和存储不对数据进行加工处理.

### 创建任务逻辑

在创建任务的时候解析上面的json,将data拆解出来,进行存储待标注/质检逻辑的时候 整体直接返回.

### 数据校验以及模板校验
在创建模板的时候将结果模板和统计模板进行比对,自动生成模拟数据到es,在es中进行模拟统计,及时响应检测结果.

对于模板的校验是实时的,也就是说是同步的,为了保证模板的准确性必须对其进行校验.

#### 数据校验
在导入数据的时候将结果模板统计模板结合导入的数据进行校验.

由于数据量可能会很大,数据的校验是异步产生的,过程如下描述:
1. 下载原始数据;
2. 原始数据与结果数据进行字段匹配;
3. 原始数据结合统计模板进行字段匹配;

### 数据库设计
详情见[^01]

[^01]:状态流转

---------------

# 状态修改
状态修改是一个很重要的问题,理论上撞他修改在整个系统中应该是原子性的,独立性的操作,每一个状态的修改应该获取一把全局的锁.

## 设计需要遵守的原则
1. 一个任务中的切片被获取直到切换到下一个状态这些操作都应该封装在一个事务中,而且需要再出现异常的情况下清理现场;
2. 对于状态的改变必须做到线程安全,目前会先从Redis池中获取切片,所以相对是线程安全的;
3. 状态的修改应该交给指定的方法,一旦修改状态,就必须同时更改DB中所有的表和Redis池;
4. 所有的修改状态操作都应该先去Redis池中获取需要修改的fragmentID.

## 使用数据池代替锁
因为对状态的变更会涉及到数据库的行锁对性能有很大的影响,所以这里会维护多个数据池,每个数据池代表着当前任务的每种状态,如下图所示:

![](http://ww3.sinaimg.cn/large/006tNc79ly1g51ii9eoy6j30dj0m0mzg.jpg)

## 统一封装修改状态的操作
1. 对于在数据池中的切片而言,修改状态意味着从一个池移动到另一个池中;
2. 对于数据库中的状态,需要将其修改成对应的状态, 而且status这个字段可能会冗余到多个表中;

修改状态单独封装成一个方法,对外暴露功能,禁止开发人员直接通过数据库操作修改状态,这样做可以极大程度降低状态紊乱的情况发生,而且对于事务的可控制可以更容易.

### 代码实现
1. 将具操作的接收着和具体的执行者进行解耦
2. 状态的更改被封装为多个组合的命令

![](http://ww1.sinaimg.cn/large/006tNc79ly1g51s4sdlkjj30g50b8gms.jpg)

---------------

# 任务状态流转

我们的任务状态比较多,而且还会随着业务的发展添加,最关键的是不同的任务可能会有不同的状态流转,在设计的时候我们需要保证一下几点:
- 每个模板的状态流转都是可配置的(通过json模板)
- 后台新增状态流转必须做到解耦
- 状态流转区分先后顺序
- 状态会有分类
    - 初始状态:负责开启一个数据流
    - 过程状态:负责数据流转
    - 终结状态:负责终结数据流
 - 对于原始数据和结果数据不进行处理

## 数据库设计
在任务流转的过程中,不会对过去的数据负责,所以只需要在数据库中保存当前的任务状态即可,当所有的任务处理完成则状态统一.

根据上面的这句话,在数据库中体现为设计一张表,存储标注之间过程中的元数据即可

## 任务流转中的元数据
- taskId:该任务ID
- newStatus:当前的状态码
- nextStatus:需要改变的状态码
- optionUser:操作用户
- 待补充

## 设计实现
下图为后端处理状态的整体逻辑

![](http://ww1.sinaimg.cn/large/006tNc79ly1g50tjr4lqfj305009sq38.jpg)

一次状态处理拆分为一下5步,所有的处理器、事件、主逻辑完全解耦，各分部执行顺序由各自的Manager决定
1. 发布开始事件;
2. 执行前置处理器;
3. 执行主业务逻辑;
4. 执行后置处理器;
5. 发布结束事件;

## 主流程设计
下图为后端代码结构

![](http://ww2.sinaimg.cn/large/006tNc79ly1g59rz8ircuj32x70p0wr2.jpg)

-----------------

# 任务统计
后台只存储任务的基本字段,这些字段适用于所有的模板.

## 基础元数据统计
这部分的统计逻辑和之前类似,会对任务的元数据进行统计

## 定制化数据统计

每个模板和任务的特定统计字段,需要在模板中配置,配置内容如下:
- 统计字段,可以通过数据模板的形式体现,后端可以直接提取
- 聚合语句,直接将es的聚合语句暴露在前段,统计的时候将聚合语句拼接然后换取统计结果

## 数据运营
数据运营这一点,我的理解是对全站的数据进行统计和分析,我们所做的是一个平台,也就是说所有的操作都是由人产生的,换句话说,所有的数据来源都是用户的操作,那么我们要做的就是记录用户所有的操作,然后对其进行分析.

------------------

# 数据库设计

![](http://ww2.sinaimg.cn/large/006tNc79ly1g52pkmo5ktj30h80cegnq.jpg)