# 事件梳理

## 问题描述

godeye测试环境中dolphin-oral-server服务在内网调用其他服务时偶尔出现5秒卡顿,但是在外部网络调用不会出现卡顿.

## 调查过程

1. 对dolphin-oral-server服务自身以及调用目标进行打点计时,发送方接收响应式出现卡顿,目标服务正常;
2. 对网关以及Nginx进行打点计时,均未出现超时;
3. 由于外网访问正常而内网不正常,排除网络传输问题;
4. 外网访问与内网的区别是URL不同以及DNS解析所获取的ip不同,但是实际上接受最终接受请求的都是Nginx,所以尝试跳过DNS解析直接访问ip,成功解决卡顿现象.

## 解决方案

在内网环境DNS解析是交个k8s中CoreDNS去做的,所以godeye测试环境的image镜像需要手动添加hosts文件跳过DNS的解析过程.

### 方案一deployment.yaml区分环境

在godeye-test环境的deployment.yaml文件中指定host([官方文档](https://kubernetes.io/docs/concepts/services-networking/add-entries-to-pod-etc-hosts-with-host-aliases/#adding-additional-entries-with-hostaliases))

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
...
spec:
...
  template:
    metadata:
...
    spec:
...
      hostAliases:
        - ip: 10.19.250.207
          hostnames:
            - internal.gateway-godeye-test.facethink.com
```



### 方案二dockerfile区分环境

将dockerfile区分为gedeye-test环境和线上环境,并且在测试环境中添加如下命令

```dockerfile
RUN echo "10.19.250.207 internal.gateway-godeye-test.facethink.com"  >> /etc/hosts
```

最终会更改image的hosts文件

### 方案三运行pod后进入容器手动更改

进入容器 手动修改hosts添加如下内容

```
10.19.250.207 internal.gateway-godeye-test.facethink.com
```

## 注意

**在阿里云线上环境不可以携带godeye测试环境中的hosts配置**

