## 任务描述
一个请求的链路分为多个环节,需要把每个环节的超时以及异常传递处理好,重点处理

- gateway到业务 超时/异常传递
- 业务到gateway 超时/异常传递

## 实现思路
![](https://tva1.sinaimg.cn/large/006tNbRwly1g9v7qc78czj30qo0zk7av.jpg)

- 对Nginx日志进行统一收集
- 在网关添加统一异常处理对网关所代理的服务的异常进行捕捉,定义统一异常格式进行返回
	- 对业务方返回的可用异常直接进行返回
	- 对业务方返回的不可用异常指定业务名称
	- 明确整理gateway网关内部的异常
- 对所有请求的信息(类似Nginx日志)进行打印
	- 请求url/requestId/响应时间/状态码/message

## 技术方案

#### nginx-control请求记录

- 收集nginx-control调用Gateway的日志
- 将日志信息存储到es中

### gateway请求记录

- 每次请求结束在网关中记录url/requestId/响应时间/状态码/message
	- 添加filter在流结束后开启新的流对信息进行记录
	- 记录的信息异步上报给kafka


### 网关内部异常

- 区分网关内部与业务调用异常
	- 内部异常:属于网关内部抛出的异常,会修改message以及code
	- 业务调用异常:
		- 业务返回的异常:网关不处理直接将业务返回的异常进行传递
		- 业务未处理异常(网络中断/服务丢失):根据异常情况返回出错服务名称+错误message
		- 记录的信息异步上报给kafka

### 记录存储:
- 存储过程
	- kafka->logstash->es
	- 索引名称: 待定
	- 索引按天自增

### 压测
- 需要对稳定性进行压测
- 获取新的网关性能

### 已存在的状态码
https://wiki.zhiyinlou.com/pages/viewpage.action?pageId=10646020

### 异常传递
会细化5000000错误的返回信息

#### 实例
```
{
    "code": 5000000,
    "msg": "aiclient-test:Connection prematurely closed BEFORE response  requestId:1576577059178656557302572507136",
    "result": "系统异常"
}
```