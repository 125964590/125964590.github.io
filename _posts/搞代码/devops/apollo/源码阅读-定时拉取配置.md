# 源码阅读---定时拉取配置
![](https://ws2.sinaimg.cn/large/006tNc79ly1g24vmnxd0xj30p106fmxe.jpg)

### AbstractConfigRepository
- 提供模板方法trySync(),具体实现交由子类
- 管理监听者集合(添加,删除)
- fire!!通知监听者拉取配置改变状态
```java
       protected void fireRepositoryChange(String namespace, Properties newProperties) {
    for (RepositoryChangeListener listener : m_listeners) {
      try {
        listener.onRepositoryChange(namespace, newProperties);
      } catch (Throwable ex) {
        Tracer.logError(ex);
        logger.error("Failed to invoke repository change listener {}", listener.getClass(), ex);
      }
    }
  }
```

### RemoteConfigRepository
```java
 static {
    m_executorService = Executors.newScheduledThreadPool(1,
        ApolloThreadFactory.create("RemoteConfigRepository", true));
  }
```
单线程维持调用

```java
   if (!m_loadConfigRateLimiter.tryAcquire(5, TimeUnit.SECONDS)) {
      //wait at most 5 seconds
      try {
        TimeUnit.SECONDS.sleep(5);
      } catch (InterruptedException e) {
      }
    }
```
很有意思防止快速重试设置了等待时间
==assembleQueryConfigUrl()==组装请求的URL(根据appid,cluster,namespace)

```java
  Transaction transaction = Tracer.newTransaction("Apollo.ConfigService", "queryConfig");
        transaction.addData("Url", url);
```
开启事务,完成查询之后返回结果

```java
      if (previous != current) {
        logger.debug("Remote Config refreshed!");
        m_configCache.set(current);
        this.fireRepositoryChange(m_namespace, this.getConfig());
      }

      if (current != null) {
        Tracer.logEvent(String.format("Apollo.Client.Configs.%s", current.getNamespaceName()),
            current.getReleaseKey());
      }
```
将结果和本地的数据进行比较如果不同,出发fire!!将配置更新到所有监听者.

#### 长轮询
长轮询的开启入口在构造方法,调用下面的方法进入长轮询 
```java
  private void scheduleLongPollingRefresh() {
    remoteConfigLongPollService.submit(m_namespace, this);
  }
```
完成长轮询之后执行通知继续新一轮的长轮询
```java
 for (RemoteConfigRepository remoteConfigRepository : toBeNotified) {
        try {
          remoteConfigRepository.onLongPollNotified(lastServiceDto, remoteMessages);
        } catch (Throwable ex) {
          Tracer.logError(ex);
        }
      }
```