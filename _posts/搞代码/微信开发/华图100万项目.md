# 开发微信公众号的意义
- 微信本身就是一个载体,在微信之上建立微信公众号,服务微信的使用者,同理微信自然也为你准备了一大批受众.
- 微信公众号也可以算作一种独立的产品,所以我的目的就是通过微信公众号,来帮助微信的使用者更好的完成想要做的事,仅仅就通过微信公众号就可以避免很多繁琐的过程.

**所以我准备做一个功能行的公众号**

## 开发前的准备
- [微信测试号](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login)
- [ngrock](https://www.ngrok.cc/)
- [微信接口调试平台](https://mp.weixin.qq.com/debug/)
- [微信开发文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432)
- [微信javasdk开源框架](https://github.com/Wechat-Group/weixin-java-tools/wiki)
## 准备阶段(先使用springboot做吧)￣□￣｜｜
1. 基础搭建
    1. 目前先使用springboot吧,基础的脚手架,满足基本业务即可
    2. 使用ngrock将本地的项目映射到公网上,之后查看文档连接微信服务器
2. 连接微信服务器
    1. 在开发微信公众号之前,需要接入微信(微信开发文档)
3. 生成自定义菜单
    1. 连接上微信公众号之后获取access_token,查看开发文档了解微信自定义菜单规则,之后使用接口调试工具生成菜单.
    2. 通过微信自定义菜单的点击事件完成基本功能,微信每次点击菜单都会向后台接口发送通知,以xml的形势,所以我们要解析.
    3. 简单的返回逻辑,被动回复,图片,文字都可以,同样也是xml形势,这里有个坑o(╥﹏╥)o  **(touser  or  fromuser)**.
4. 制作带参数二维码
    1. 获取access_token,通过access_token使用微信接口文档换取带参数的二维码,具体方法微信开发文档上有详细的介绍.
    2. 带参数的二维码,扫描之后相当于点击了按钮,同样也是要触发点击事件,拦截事件之后判断参数内容,并且处理相关逻辑.
5. 事件推送
    1. 在公众号上选取适合的模板信息,使用模板id进行空模板消息推送
6. 定时推送任务
    1.使用springboot自带的定时器,@Scheduled注解来完成定时任务,相当于主动发送消息,主动向关注的用户推送相关消息.
7. 网页登录授权认证
    1. 比较复杂的一项技术,使用oAuth2授权模式,详细信息可以阅读官方文档,采用回调的模式.
    2. 同样是通过点击时间,使用view菜单按钮,当点击的时候请求后台接口,再由后台请求微信服务器,请求的同同时将回调的域名写进请求的参数中,当微信通过授权之后,会将我们的页面跳转到我们所填写的回调页面,这样就可以做到在位新页面将用户的openId带出去了.

## 具体实现
### 1. 基础搭建
springboot 
- 搭建web基础支持,jpa,restAPI,redis缓存,构建好.
- 使用wxjsdk所以有很多场量不需要自己封装,wxjsdk中都包含了.
- 写一个接口用来完成微信的连接验证
ngrock
- 上官网申请一个免费的ngrock账号,之后开通映射填写相应的对口号,将项目运行起来检测一下外网是否可以访问.

### 2. 连接微信服务器
开启ngrock并且确定微信测试号上的token与你代码里的是一样的,之后阅读官方文档理解微信的校验逻辑,运行代码完成校验

```java
 @GetMapping(value = "process")
    public void checkSignature(@RequestParam(name = "signature", required = false) String signature,
                               @RequestParam(name = "nonce", required = false) String nonce,
                               @RequestParam(name = "timestamp", required = false) String timestamp,
                               @RequestParam(name = "echostr", required = false) Object echostr, HttpServletResponse resp) {
        // 通过检验signature对请求进行校验，若校验成功则原样返回echostr，表示接入成功，否则接入失败
        log.info("-------开始验证----------signature:{},nonce:{},timestamp:{},echostr:{}", signature, nonce, timestamp, echostr);
        try {

            PrintWriter out = resp.getWriter();
            if (SignUtil.checkSignature(signature, timestamp, nonce)) {
                log.info("接入成功");
                //  return echostr;
                out.print(echostr);
                return;
            }
            log.error("接入失败");
            out.print(echostr);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

```

### 3. 生成自定义菜单
查询官方文档了解自定义菜单的结构,使用微信提供的接口调试工具进行菜单的编写
```json
{
  "button": [
    {
      "type": "scancode_waitmsg",
      "name": "扫码签到",
      "key": "m_duanzi"
    },
    {
      "type": "click",
      "name": "课程安排",
      "key": "course"
    },
    {
      "name": "我的",
      "sub_button": [
        {
          "type": "view",
          "name": "学习效果",
          "url": "http://weixin.htexam.com/wx/api/lr/pre",
          "sub_button": []
        },
        {
          "type": "view",
          "name": "个人信息",
          "url": "http://weixin.htexam.com/wx/api/userView",
          "sub_button": []
        },
        {
          "type": "click",
          "name": "联系客服",
          "key": "conn_service"
        }
      ]
    }
  ]
}
```
### 4.带参数二维码校验
使用swatch对点击事件进行分析
```java
 switch (requestMap.get("MsgType")) {
    //文本消息
    case MessageUtil.REQ_MESSAGE_TYPE_TEXT: {
        result = messageHandler.TextMessageHandler(requestMap);
    }   //图片消息
    case MessageUtil.REQ_MESSAGE_TYPE_IMAGE: {
        break;
    }   //链接消息
    case MessageUtil.REQ_MESSAGE_TYPE_LINK: {
        break;
    }   //地理消息
    case MessageUtil.REQ_MESSAGE_TYPE_LOCATION: {
        break;
    }   //音频消息
    case MessageUtil.REQ_MESSAGE_TYPE_VOICE: {
        break;
    }   //事件
 }
```
筛选之后进入相应的heandlerchuli
```java
 List<NotificationType> notTypePatterns = notificationTypeRepository.findByBizStatusAndStatus
            (new Sort(Sort.Direction.DESC, "gmtModify"), WXStatusEnum.BizStatus.ONLINE.getBizSatus(), WXStatusEnum.Status.NORMAL.getStatus());
    for (NotificationType notificationType : notTypePatterns) {
        if (StringUtils.isNotEmpty(notificationType.getWxImageId())) {
            log.info("----展示图片----");
            str = WxMpXmlOutMessage
                    .IMAGE()
                    .mediaId(notTypePatterns.get(0).getWxImageId())
                    .fromUser(requestMap.get("ToUserName"))
                    .toUser(requestMap.get("FromUserName"))
                    .build()
                    .toXml();
            break;
        }
    }
}
```
### 5.定时任务推送
通过springboot自带的定时器来完成定时任务,定时任务的书写规则可以去网上找生成工具,通过生成工具来帮助你完成定时任务的安排
```java
//每天晚八点（20：00）执行定时任务
@Scheduled(cron="0 0 20 * * ?")
public void submitMatchAnswer() throws BizException {
    if (!getLock()) {
        return;
    }
    String serverIp = "";
    try {
        serverIp = getServerIp();
        log.info("getServerIp:"+getServerIp());
        //处理业务
        //生成学习报告并推送
        learningReportService.dailyReport();
    } catch (UnknownHostException e) {
        e.printStackTrace();
    }finally {
        unlock();
    }
    log.info("auto submit match answer task end.server={}", serverIp);
}
```
### 7. 网页登录授权认证
网页授权登录这是一大章,设计oAuth2授权模式,以及url多次回调的请求模式,单独分一栏来记录